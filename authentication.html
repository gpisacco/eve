
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Authentication and Authorization &mdash; Eve 0.3-dev documentation</title>
    
    <link rel="stylesheet" href="_static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.3-dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="top" title="Eve 0.3-dev documentation" href="index.html" />
    <link rel="next" title="Tutorials" href="tutorials/index.html" />
    <link rel="prev" title="Data Validation" href="validation.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body>
  
  

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="tutorials/index.html" title="Tutorials"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="validation.html" title="Data Validation"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Eve 0.3-dev documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="authentication-and-authorization">
<span id="auth"></span><h1>Authentication and Authorization<a class="headerlink" href="#authentication-and-authorization" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction-to-security">
<h2>Introduction to Security<a class="headerlink" href="#introduction-to-security" title="Permalink to this headline">¶</a></h2>
<p>Authentication is the mechanism whereby systems may securely identify their
users. Eve supports several authentication schemes: Basic Authentication, Token
Authentication, HMAC Authentication.</p>
<p>Authorization is the mehcanism by which a system determines what level of
access a particular (authenticated) user should have access to resources
controlled by the system. In Eve, you can restrict access to all API endpoints,
or only some of them. You can protect some HTTP verbs while leaving others
open. For example, you can allow public read-only access while leaving item
creation and edition restricted to authorized users only. You can also allow
<tt class="docutils literal"><span class="pre">GET</span></tt> access for certain requests and <tt class="docutils literal"><span class="pre">POST</span></tt> access for others by checking
the method parameter. There is also support for role-based access control.</p>
<p>Security is one of those areas where customization is very important. This is
why you are provided with a handful of base authentication classes. They
implement the basic authentication mechanism and must be subclassed in order
to implement authorization logic. No matter which authentication scheme you
pick the only thing that you need to do in your subclass is override the
<tt class="docutils literal"><span class="pre">check_auth()</span></tt> method.</p>
</div>
<div class="section" id="global-authentication">
<h2>Global Authentication<a class="headerlink" href="#global-authentication" title="Permalink to this headline">¶</a></h2>
<p>To enable authentication for your API just pass the custom auth class on
app instantiation. In our example we&#8217;re going to use the <tt class="docutils literal"><span class="pre">BasicAuth</span></tt> base
class, which implements the <a class="reference internal" href="#basic"><em>Basic Authentication</em></a> scheme:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">eve.auth</span> <span class="kn">import</span> <span class="n">BasicAuth</span>

<span class="k">class</span> <span class="nc">MyBasicAuth</span><span class="p">(</span><span class="n">BasicAuth</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">check_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">allowed_roles</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span>
                   <span class="n">method</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">username</span> <span class="o">==</span> <span class="s">&#39;admin&#39;</span> <span class="ow">and</span> <span class="n">password</span> <span class="o">==</span> <span class="s">&#39;secret&#39;</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Eve</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">MyBasicAuth</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>All your API endpoints are now secured, which means that a client will need
to provide the correct credentials in order to consume the API:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> curl -i http://example.com
<span class="go">HTTP/1.1 401 UNAUTHORIZED</span>
<span class="go">Please provide proper credentials.</span>

<span class="gp">$</span> curl -H <span class="s2">&quot;Authorization: Basic YWRtaW46c2VjcmV0&quot;</span> -i http://example.com
<span class="go">HTTP/1.1 200 OK</span>
</pre></div>
</div>
<p>By default access is restricted to all endpoints for all HTTP verbs
(methods), effectively locking down the whole API.</p>
<p>But what if your authorization logic is more complex, and you only want to
secure some endpoints or apply different logics depending on the
endpoint being consumed? You could get away with just adding logic to your
authentication class, maybe with something like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MyBasicAuth</span><span class="p">(</span><span class="n">BasicAuth</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">check_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">allowed_roles</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">resource</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;zipcodes&#39;</span><span class="p">,</span> <span class="s">&#39;countries&#39;</span><span class="p">):</span>
            <span class="c"># &#39;zipcodes&#39; and &#39;countries&#39; are public</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># all the other resources are secured</span>
            <span class="k">return</span> <span class="n">username</span> <span class="o">==</span> <span class="s">&#39;admin&#39;</span> <span class="ow">and</span> <span class="n">password</span> <span class="o">==</span> <span class="s">&#39;secret&#39;</span>
</pre></div>
</div>
<p>If needed, this approach also allows to take the request <tt class="docutils literal"><span class="pre">method</span></tt> into
consideration, for example to allow <tt class="docutils literal"><span class="pre">GET</span></tt> requests for everyone while forcing
validation on edits (<tt class="docutils literal"><span class="pre">POST</span></tt>, <tt class="docutils literal"><span class="pre">PUT</span></tt>, <tt class="docutils literal"><span class="pre">PATCH</span></tt>, <tt class="docutils literal"><span class="pre">DELETE</span></tt>).</p>
</div>
<div class="section" id="endpoint-level-authentication">
<h2>Endpoint-level Authentication<a class="headerlink" href="#endpoint-level-authentication" title="Permalink to this headline">¶</a></h2>
<p>The <em>one class to bind them all</em> approach seen above is probably good for most
use cases but as soon as authorization logic gets more complicated it could
easily lead to complex and unmanageable code, something you don&#8217;t really want
to have when dealing with security.</p>
<p>Wouldn&#8217;t it be nice if we could have specialized auth classes that we could
freely apply to selected endpoints? This way the global level auth class, the
one passed to the Eve constructor as seen above, would still be active on all
endpoints except those where different authorization logic is needed.
Alternatively, we could even choose to <em>not</em> provide a global auth class,
effectively making all endpoints public, except the ones we want protected.
With a system like this we could even choose to have some endpoints protected
with, say, Basic Authentication while others are secured with Token, or HMAC
Authentication!</p>
<p>Well, turns out this is actually possible by simply enabling the
resource-level <tt class="docutils literal"><span class="pre">authentication</span></tt> setting when we are defining the API
<a class="reference internal" href="config.html#domain"><em>domain</em></a>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">DOMAIN</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;people&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;authentication&#39;</span><span class="p">:</span> <span class="n">MySuperCoolAuth</span><span class="p">,</span>
        <span class="o">...</span>
        <span class="p">},</span>
    <span class="s">&#39;invoices&#39;</span><span class="p">:</span> <span class="o">...</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>And that&#8217;s it. The <cite>people</cite> endpoint will now be using the <tt class="docutils literal"><span class="pre">MySuperCoolAuth</span></tt>
class for authentication, while the <tt class="docutils literal"><span class="pre">invoices</span></tt> endpoint  will be using the
general-purpose auth class if provided or else it will just be open to the
public.</p>
<p>There are other features and options that you can use to reduce complexity in
your auth classes, especially (but not only) when using the global level
authentication system. Lets review them.</p>
</div>
<div class="section" id="global-endpoint-security">
<h2>Global Endpoint Security<a class="headerlink" href="#global-endpoint-security" title="Permalink to this headline">¶</a></h2>
<p>You might want a public read-only API where only authorized users can write,
edit and delete. You can achieve that by using the <tt class="docutils literal"><span class="pre">PUBLIC_METHODS</span></tt> and
<tt class="docutils literal"><span class="pre">PUBLIC_ITEM_METHODS</span></tt> <a class="reference internal" href="config.html#global"><em>global settings</em></a>. Add the following to
your <cite>settings.py</cite>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">PUBLIC_METHODS</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">]</span>
<span class="n">PUBLIC_ITEM_METHODS</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>And run your API. POST, PATCH and DELETE are still restricted, while GET is
publicly available at all API endpoints. <tt class="docutils literal"><span class="pre">PUBLIC_METHODS</span></tt> refers to resource
endpoints, like <tt class="docutils literal"><span class="pre">/people</span></tt>, while <tt class="docutils literal"><span class="pre">PUBLIC_ITEM_METHODS</span></tt> refers to individual
items like <tt class="docutils literal"><span class="pre">/people/id</span></tt>.</p>
</div>
<div class="section" id="custom-endpoint-security">
<span id="endpointsec"></span><h2>Custom Endpoint Security<a class="headerlink" href="#custom-endpoint-security" title="Permalink to this headline">¶</a></h2>
<p>Suppose that you want to allow public read access to only certain resources.
You do that by declaring public methods at resource level, while declaring the
API <a class="reference internal" href="config.html#domain"><em>domain</em></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">DOMAIN</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;people&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;public_methods&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">],</span>
        <span class="s">&#39;public_item_methods&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">],</span>
        <span class="p">},</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>Be aware that, when present, <a class="reference internal" href="config.html#local"><em>resource settings</em></a> override global
settings. You can use this to your advantage. Suppose that you want to grant
read access to all endpoints with the only exception of <tt class="docutils literal"><span class="pre">/invoices</span></tt>.  You
first open read access for all endpoints:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">PUBLIC_METHODS</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">]</span>
<span class="n">PUBLIC_ITEM_METHODS</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Then you protect the private endpoint:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">DOMAIN</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;invoices&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;public_methods&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s">&#39;public_item_methods&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>Effectively making <cite>invoices</cite> a restricted resource.</p>
</div>
<div class="section" id="basic-authentication">
<span id="basic"></span><h2>Basic Authentication<a class="headerlink" href="#basic-authentication" title="Permalink to this headline">¶</a></h2>
<p>The <tt class="docutils literal"><span class="pre">eve.auth.BasicAuth</span></tt> class allows the implementation of Basic
Authentication (RFC2617). It should be subclassed in order to implement custom
authentication.</p>
<div class="section" id="basic-authentication-with-bcrypt">
<h3>Basic Authentication with bcrypt<a class="headerlink" href="#basic-authentication-with-bcrypt" title="Permalink to this headline">¶</a></h3>
<p>Encoding passwords with <a class="reference external" href="http://en.wikipedia.org/wiki/Bcrypt">bcrypt</a> is a great idea. It comes at the cost of
performance, but that&#8217;s precisely the point, as slow encoding means very good
resistance to brute-force attacks. For a faster (and less safe) alternative, see
the SHA1/MAC snippet further below.</p>
<p>This script assumes that user accounts are stored in an <cite>accounts</cite> MongoDB
collection, and that passwords are stored as bcrypt hashes. All API
resources/methods will be secured unless they are made explicitly public.</p>
<div class="admonition-please-note admonition">
<p class="first admonition-title">Please note</p>
<p class="last">You will need to install <cite>py-bcript</cite> for this to work.</p>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Auth-BCrypt</span>
<span class="sd">    ~~~~~~~~~~~</span>

<span class="sd">    Securing an Eve-powered API with Basic Authentication (RFC2617).</span>

<span class="sd">    You will need to install py-bcrypt: ``pip install py-bcrypt``</span>

<span class="sd">    This snippet by Nicola Iarocci can be used freely for anything you like.</span>
<span class="sd">    Consider it public domain.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">bcrypt</span>
<span class="kn">from</span> <span class="nn">eve</span> <span class="kn">import</span> <span class="n">Eve</span>
<span class="kn">from</span> <span class="nn">eve.auth</span> <span class="kn">import</span> <span class="n">BasicAuth</span>


<span class="k">class</span> <span class="nc">BCryptAuth</span><span class="p">(</span><span class="n">BasicAuth</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">check_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">allowed_roles</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="c"># use Eve&#39;s own db driver; no additional connections/resources are used</span>
        <span class="n">accounts</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s">&#39;accounts&#39;</span><span class="p">]</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">accounts</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">account</span> <span class="ow">and</span> \
            <span class="n">bcrypt</span><span class="o">.</span><span class="n">hashpw</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">account</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="n">account</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">]</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Eve</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">BCryptAuth</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="basic-authentication-with-sha1-hmac">
<h3>Basic Authentication with SHA1/HMAC<a class="headerlink" href="#basic-authentication-with-sha1-hmac" title="Permalink to this headline">¶</a></h3>
<p>This script assumes that user accounts are stored in an <cite>accounts</cite> MongoDB
collection, and that passwords are stored as SHA1/HMAC hashes. All API
resources/methods will be secured unless they are made explicitly public.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Auth-SHA1/HMAC</span>
<span class="sd">    ~~~~~~~~~~~~~~</span>

<span class="sd">    Securing an Eve-powered API with Basic Authentication (RFC2617).</span>

<span class="sd">    Since we are using werkzeug we don&#39;t need any extra import (werkzeug being</span>
<span class="sd">    one of Flask/Eve prerequisites).</span>

<span class="sd">    This snippet by Nicola Iarocci can be used freely for anything you like.</span>
<span class="sd">    Consider it public domain.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">eve</span> <span class="kn">import</span> <span class="n">Eve</span>
<span class="kn">from</span> <span class="nn">eve.auth</span> <span class="kn">import</span> <span class="n">BasicAuth</span>
<span class="kn">from</span> <span class="nn">werkzeug.security</span> <span class="kn">import</span> <span class="n">check_password_hash</span>


<span class="k">class</span> <span class="nc">Sha1Auth</span><span class="p">(</span><span class="n">BasicAuth</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">check_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">allowed_roles</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="c"># use Eve&#39;s own db driver; no additional connections/resources are used</span>
        <span class="n">accounts</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s">&#39;accounts&#39;</span><span class="p">]</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">accounts</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">account</span> <span class="ow">and</span> \
            <span class="n">check_password_hash</span><span class="p">(</span><span class="n">account</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">],</span> <span class="n">password</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Eve</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">Sha1Auth</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="token-based-authentication">
<span id="token"></span><h2>Token-Based Authentication<a class="headerlink" href="#token-based-authentication" title="Permalink to this headline">¶</a></h2>
<p>Token-based authentication can be considered a specialized version of Basic
Authentication. The Authorization header tag will contain the auth token as the
username, and no password.</p>
<p>This script assumes that user accounts are stored in an <cite>accounts</cite> MongoDB
collection. All API resources/methods will be secured unless they are made
explicitly public (by fiddling with some settings you can open one or more
resources and/or methods to public access -see docs).</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Auth-Token</span>
<span class="sd">    ~~~~~~~~~~</span>

<span class="sd">    Securing an Eve-powered API with Token based Authentication.</span>

<span class="sd">    This snippet by Nicola Iarocci can be used freely for anything you like.</span>
<span class="sd">    Consider it public domain.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">eve</span> <span class="kn">import</span> <span class="n">Eve</span>
<span class="kn">from</span> <span class="nn">eve.auth</span> <span class="kn">import</span> <span class="n">TokenAuth</span>


<span class="k">class</span> <span class="nc">TokenAuth</span><span class="p">(</span><span class="n">TokenAuth</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">check_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">allowed_roles</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For the purpose of this example the implementation is as simple as</span>
<span class="sd">        possible. A &#39;real&#39; token should probably contain a hash of the</span>
<span class="sd">        username/password combo, which sould then validated against the account</span>
<span class="sd">        data stored on the DB.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># use Eve&#39;s own db driver; no additional connections/resources are used</span>
        <span class="n">accounts</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s">&#39;accounts&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">accounts</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s">&#39;token&#39;</span><span class="p">:</span> <span class="n">token</span><span class="p">})</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Eve</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">TokenAuth</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="hmac-authentication">
<h2>HMAC Authentication<a class="headerlink" href="#hmac-authentication" title="Permalink to this headline">¶</a></h2>
<p>The <tt class="docutils literal"><span class="pre">eve.auth.HMACAuth</span></tt> class allows for custom, Amazon S3-like, HMAC (Hash
Message Authentication Code) authentication, which is basically a very secure
custom authentication scheme built around the <cite>Authorization</cite> header.</p>
<div class="section" id="how-hmac-authentication-works">
<h3>How HMAC Authentication Works<a class="headerlink" href="#how-hmac-authentication-works" title="Permalink to this headline">¶</a></h3>
<p>The server provides the client with a user id and a secret key through some
out-of-band technique (e.g., the service sends the client an e-mail
containing the user id and secret key). The client will use the supplied
secret key to sign all requests.</p>
<p>When the client wants to send a request, he builds the complete request and
then, using the secret key, computes a hash over the complete message body (and
optionally some of the message headers if required)</p>
<p>Next, the client adds the computed hash and his userid to the message in the
Authorization header:</p>
<div class="highlight-python"><pre>Authorization: johndoe:uCMfSzkjue+HSDygYB5aEg==</pre>
</div>
<p>and sends it to the service. The service retrieves the userid from the
message header and searches the private key for that user in its own
database. Next it computes the hash over the message body (and selected
headers) using the key to generate its hash. If the hash the client sends
matches the hash the server computes, then the server knows the message was
sent by the real client and was not altered in any way.</p>
<p>Really the only tricky part is sharing a secret key with the user and keeping
that secure. That is why some services allow for generation of shared keys
with a limited life time so you can give the key to a third party to
temporarily work on your behalf. This is also the reason why the secret key
is generally provided through out-of-band channels (often a webpage or, as
said above, an email or plain old paper).</p>
<p>The <tt class="docutils literal"><span class="pre">eve.auth.HMACAuth</span></tt>  class also support access roles.</p>
</div>
<div class="section" id="hmac-example">
<h3>HMAC Example<a class="headerlink" href="#hmac-example" title="Permalink to this headline">¶</a></h3>
<p>The snippet below can also be found in the <cite>examples/security</cite> folder of the
Eve <a class="reference external" href="https://github.com/nicolaiarocci/eve">repository</a>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">eve</span> <span class="kn">import</span> <span class="n">Eve</span>
<span class="kn">from</span> <span class="nn">eve.auth</span> <span class="kn">import</span> <span class="n">HMACAuth</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">sha1</span>
<span class="kn">import</span> <span class="nn">hmac</span>


<span class="k">class</span> <span class="nc">HMACAuth</span><span class="p">(</span><span class="n">HMACAuth</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">check_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userid</span><span class="p">,</span> <span class="n">hmac_hash</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">allowed_roles</span><span class="p">,</span>
                   <span class="n">resource</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="c"># use Eve&#39;s own db driver; no additional connections/resources are</span>
        <span class="c"># used</span>
        <span class="n">accounts</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s">&#39;accounts&#39;</span><span class="p">]</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">accounts</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s">&#39;userid&#39;</span><span class="p">:</span> <span class="n">userid</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">secret_key</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;secret_key&#39;</span><span class="p">]</span>
        <span class="c"># in this implementation we only hash request data, ignoring the</span>
        <span class="c"># headers.</span>
        <span class="k">return</span> <span class="n">user</span> <span class="ow">and</span> \
            <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">secret_key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">sha1</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">==</span> \
                <span class="n">hmac_hash</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Eve</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">HMACAuth</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="role-based-access-control">
<span id="roleaccess"></span><h2>Role Based Access Control<a class="headerlink" href="#role-based-access-control" title="Permalink to this headline">¶</a></h2>
<p>The code snippets above deliberately ignore the <tt class="docutils literal"><span class="pre">allowed_roles</span></tt> parameter.
You can use this parameter to restrict access to authenticated users who also
have been assigned specific roles.</p>
<p>First, you would use the new <tt class="docutils literal"><span class="pre">ALLOWED_ROLES</span></tt> and <tt class="docutils literal"><span class="pre">ALLOWED_ITEM_ROLES</span></tt> <a class="reference internal" href="config.html#global"><em>global
settings</em></a> (or the corresponding <tt class="docutils literal"><span class="pre">allowed_roles</span></tt> and <tt class="docutils literal"><span class="pre">allowed_item_roles</span></tt>
<a class="reference internal" href="config.html#local"><em>resource settings</em></a>).</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">ALLOWED_ROLES</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;admin&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Then your subclass would implement the authorization logic by making good use
of the aforementioned <tt class="docutils literal"><span class="pre">allowed_roles</span></tt> parameter.</p>
<p>The snippet below assumes that user accounts are stored in an <cite>accounts</cite>
MongoDB collection, that passwords are stored as SHA1/HMAC hashes and that user
roles are stored in a &#8216;roles&#8217; array. All API resources/methods will be secured
unless they are made explicitly public.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Auth-SHA1/HMAC-Roles</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">    Securing an Eve-powered API with Basic Authentication (RFC2617) and user</span>
<span class="sd">    roles.</span>

<span class="sd">    Since we are using werkzeug we don&#39;t need any extra import (werkzeug being</span>
<span class="sd">    one of Flask/Eve prerequisites).</span>

<span class="sd">    This snippet by Nicola Iarocci can be used freely for anything you like.</span>
<span class="sd">    Consider it public domain.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">eve</span> <span class="kn">import</span> <span class="n">Eve</span>
<span class="kn">from</span> <span class="nn">eve.auth</span> <span class="kn">import</span> <span class="n">BasicAuth</span>
<span class="kn">from</span> <span class="nn">werkzeug.security</span> <span class="kn">import</span> <span class="n">check_password_hash</span>


<span class="k">class</span> <span class="nc">RolesAuth</span><span class="p">(</span><span class="n">BasicAuth</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">check_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">allowed_roles</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="c"># use Eve&#39;s own db driver; no additional connections/resources are used</span>
        <span class="n">accounts</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s">&#39;accounts&#39;</span><span class="p">]</span>
        <span class="n">lookup</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">allowed_roles</span><span class="p">:</span>
            <span class="c"># only retrieve a user if his roles match ``allowed_roles``</span>
            <span class="n">lookup</span><span class="p">[</span><span class="s">&#39;roles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;$in&#39;</span><span class="p">:</span> <span class="n">allowed_roles</span><span class="p">}</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">accounts</span><span class="o">.</span><span class="n">find_one</span><span class="p">(</span><span class="n">lookup</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">account</span> <span class="ow">and</span> <span class="n">check_password_hash</span><span class="p">(</span><span class="n">account</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">],</span> <span class="n">password</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Eve</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">RolesAuth</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="user-restricted-resource-access">
<span id="user-restricted"></span><h2>User-Restricted Resource Access<a class="headerlink" href="#user-restricted-resource-access" title="Permalink to this headline">¶</a></h2>
<p>When this feature is enabled, each stored document is associated with the
account that created it. This allows the API to transparently serve only
account-created documents on all kinds of requests: read, edit, delete and of
course create.  User authentication needs to be enabled for this to work
properly.</p>
<p>At the global level this feature is enabled by setting <tt class="docutils literal"><span class="pre">AUTH_FIELD</span></tt> and locally
(at the endpoint level) by setting <tt class="docutils literal"><span class="pre">auth_field</span></tt>. These properties define the name
of the field used to store the id of the user who created the document.  So for
example by setting <tt class="docutils literal"><span class="pre">AUTH_FIELD</span></tt> to <tt class="docutils literal"><span class="pre">user_id</span></tt>, you are effectively (and
transparently to the user) adding a <tt class="docutils literal"><span class="pre">user_id</span></tt> field to every stored
document. This will then be used to retrieve/edit/delete documents stored by
the user.</p>
<p>But how do you set the <tt class="docutils literal"><span class="pre">auth_field</span></tt> value? By simply setting the
<tt class="docutils literal"><span class="pre">request_auth_value</span></tt> property in your auth class. Let us revise our
BCrypt-authentication example from above:</p>
<div class="highlight-python"><div class="highlight"><pre> <span class="c"># -*- coding: utf-8 -*-</span>

 <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     Auth-BCrypt</span>
<span class="sd">     ~~~~~~~~~~~</span>

<span class="sd">     Securing an Eve-powered API with Basic Authentication (RFC2617).</span>

<span class="sd">     You will need to install py-bcrypt: ``pip install py-bcrypt``</span>

<span class="sd">     This snippet by Nicola Iarocci can be used freely for anything you like.</span>
<span class="sd">     Consider it public domain.</span>
<span class="sd"> &quot;&quot;&quot;</span>

 <span class="kn">import</span> <span class="nn">bcrypt</span>
 <span class="kn">from</span> <span class="nn">eve</span> <span class="kn">import</span> <span class="n">Eve</span>
 <span class="kn">from</span> <span class="nn">eve.auth</span> <span class="kn">import</span> <span class="n">BasicAuth</span>


 <span class="k">class</span> <span class="nc">BCryptAuth</span><span class="p">(</span><span class="n">BasicAuth</span><span class="p">):</span>
     <span class="k">def</span> <span class="nf">check_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">allowed_roles</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
         <span class="c"># use Eve&#39;s own db driver; no additional connections/resources are used</span>
         <span class="n">accounts</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">driver</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s">&#39;accounts&#39;</span><span class="p">]</span>
         <span class="n">account</span> <span class="o">=</span> <span class="n">accounts</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">})</span>
<span class="hll">         <span class="c"># set &#39;auth_field&#39; value to the account&#39;s ObjectId</span>
</span><span class="hll">         <span class="c"># (instead of _id, you might want to use ID_FIELD)</span>
</span><span class="hll">         <span class="k">if</span> <span class="n">account</span> <span class="ow">and</span> <span class="s">&#39;_id&#39;</span> <span class="ow">in</span> <span class="n">account</span><span class="p">:</span>
</span><span class="hll">             <span class="bp">self</span><span class="o">.</span><span class="n">request_auth_value</span> <span class="o">=</span> <span class="n">account</span><span class="p">[</span><span class="s">&#39;_id&#39;</span><span class="p">]</span>
</span>         <span class="k">return</span> <span class="n">account</span> <span class="ow">and</span> \
             <span class="n">bcrypt</span><span class="o">.</span><span class="n">hashpw</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">account</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="n">account</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">]</span>


 <span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
     <span class="n">app</span> <span class="o">=</span> <span class="n">Eve</span><span class="p">(</span><span class="n">auth</span><span class="o">=</span><span class="n">BCryptAuth</span><span class="p">)</span>
     <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition-please-note admonition">
<p class="first admonition-title">Please note</p>
<p class="last">The snippets in this page can also be found in the <cite>examples/security</cite>
folder of the Eve <a class="reference external" href="https://github.com/nicolaiarocci/eve">repository</a>.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><p class="logo">
  <a href="index.html">
      <img class="logo" src="_static/eve-sidebar.png" alt="Logo"/>
  </a>
</p>
<p>
  <iframe src="http://ghbtns.com/github-btn.html?user=nicolaiarocci&repo=eve&type=watch&count=true&size=large"
    allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p> 
<!--<h3>About Eve</h3>-->
<p>
  You are looking at the documentation of the development version.
</p>
<h3>Support Eve</h3>
<p>If your organization uses Eve, consider financial support:</p>
<p>
<a href="https://gum.co/EhzI" class="gumroad-button">Eve Pro</a> <script type="text/javascript" src="https://gumroad.com/js/gumroad.js"></script>
</p>
<h3>Get Updates</h3>
<p>Receive updates on new releases and upcoming projects.</p>
<p>
<a href="http://tinyletter.com/nicolaiarocci">Subscribe to Newsletter</a>
</p>
<h3>Useful Links</h3>
<ul>
  <li><a href="http://stackoverflow.com/questions/tagged/eve">Stack Overflow</a></li>
  <li><a href="https://groups.google.com/forum/#!forum/python-eve">Mailing List</a></li>
  <li><a href="http://github.com/nicolaiarocci/eve/issues">Issue Tracker</a></li>
  <li><a href="http://github.com/nicolaiarocci/eve">GitHub</a></li>
  <li><a href="http://blog.python-eve.org/">Blog</a></li>
  <li><a href="http://github.com/nicolaiarocci/eve-demo">Demo</a></li>
  <li><a href="irc://irc.freenode.net/python-eve">IRC</a>
</ul>
<h3>Feedback</h3>
<p>
  Feedback is greatly appreciated. If you have any questions, comments,
  random praise, or anonymous threats, get on the <a href="https://groups.google.com/forum/#!forum/python-eve">mailing list</a> or <a href="mailto:eve@nicolaiarocci.com">
  shoot an email</a>.
</p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Authentication and Authorization</a><ul>
<li><a class="reference internal" href="#introduction-to-security">Introduction to Security</a></li>
<li><a class="reference internal" href="#global-authentication">Global Authentication</a></li>
<li><a class="reference internal" href="#endpoint-level-authentication">Endpoint-level Authentication</a></li>
<li><a class="reference internal" href="#global-endpoint-security">Global Endpoint Security</a></li>
<li><a class="reference internal" href="#custom-endpoint-security">Custom Endpoint Security</a></li>
<li><a class="reference internal" href="#basic-authentication">Basic Authentication</a><ul>
<li><a class="reference internal" href="#basic-authentication-with-bcrypt">Basic Authentication with bcrypt</a></li>
<li><a class="reference internal" href="#basic-authentication-with-sha1-hmac">Basic Authentication with SHA1/HMAC</a></li>
</ul>
</li>
<li><a class="reference internal" href="#token-based-authentication">Token-Based Authentication</a></li>
<li><a class="reference internal" href="#hmac-authentication">HMAC Authentication</a><ul>
<li><a class="reference internal" href="#how-hmac-authentication-works">How HMAC Authentication Works</a></li>
<li><a class="reference internal" href="#hmac-example">HMAC Example</a></li>
</ul>
</li>
<li><a class="reference internal" href="#role-based-access-control">Role Based Access Control</a></li>
<li><a class="reference internal" href="#user-restricted-resource-access">User-Restricted Resource Access</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="validation.html" title="previous chapter">Data Validation</a></li>
      <li>Next: <a href="tutorials/index.html" title="next chapter">Tutorials</a></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">
    &copy; Copyright 2014. A <a href="http://nicolaiarocci.com">Nicola Iarocci</a> Project.
  </div>
  <a href="https://github.com/nicolaiarocci/eve" class="github">
      <img style="position: absolute; top: 0; right: 0; border: 0;" src="_static/forkme_right_green_007200.png" alt="Fork me on GitHub"  class="github"/>
  </a>
  
  </body>
</html>